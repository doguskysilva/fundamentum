# Observability Module

Structured logging, request tracking, and middleware.

## Components

- **setup_logging** - Configure structured logging
- **ObservabilityMiddleware** - FastAPI middleware
- **Context Functions** - Request/trace ID management
- **Logging Helpers** - Structured log utilities

## Basic Usage

```python
from fastapi import FastAPI
from fundamentum.infra.observability import (
    setup_logging,
    ObservabilityMiddleware,
    get_logger,
)

# Setup logging
logger = setup_logging(settings)

# Add middleware
app = FastAPI()
app.add_middleware(ObservabilityMiddleware)

# Get logger
logger = get_logger(__name__)

@app.get("/customers/{customer_id}")
async def get_customer(customer_id: str):
    logger.info("Fetching customer", extra={"customer_id": customer_id})
    return {"id": customer_id}
```

## Logging

```python
from fundamentum.infra.observability import setup_logging, get_logger

# Setup once at startup
logger = setup_logging(settings)

# Get logger in modules
logger = get_logger(__name__)

# Structured logging with context
logger.info(
    "Customer created",
    extra={
        "customer_id": "123",
        "email": "john@example.com"
    }
)
```

## Request ID

```python
from fundamentum.infra.observability import get_request_id, set_request_id

# Get current request ID (auto-generated by middleware)
request_id = get_request_id()

# Set custom request ID
set_request_id("custom-id-123")

# Clear request ID
from fundamentum.infra.observability import clear_request_id
clear_request_id()
```

## Trace ID

```python
from fundamentum.infra.observability import (
    get_trace_id,
    set_trace_id,
    increment_trace_id,
    append_trace_segment,
)

# Set trace ID
set_trace_id("trace-001")

# Increment (adds .1, .2, etc)
increment_trace_id()  # "trace-001.1"

# Append segment
append_trace_segment("api")  # "trace-001.1.api"

# Get current trace
trace_id = get_trace_id()
```

## Middleware

The middleware automatically:
- Generates request ID for each request
- Adds `X-Request-ID` to response headers
- Logs request/response details
- Adds request ID to log context

```python
from fastapi import FastAPI
from fundamentum.infra.observability import ObservabilityMiddleware

app = FastAPI()
app.add_middleware(ObservabilityMiddleware)
```

## Logging Helpers

```python
from fundamentum.infra.observability import (
    log_http_request,
    log_http_response,
    get_logger,
)

logger = get_logger(__name__)

# Log outgoing HTTP request
log_http_request(
    logger,
    url_name="census.get_customer",
    peer_service="census",
    url="https://census.test/api/customers/123",
    method="GET",
)

# Log HTTP response
log_http_response(
    logger,
    url_name="census.get_customer",
    peer_service="census",
    status_code=200,
    method="GET",
    duration_ms=150,
    url="https://census.test/api/customers/123",
)
```

## API Reference

**Functions:**
- `setup_logging(settings) -> Logger` - Configure structured logging
- `get_logger(name) -> Logger` - Get logger with context
- `get_request_id() -> str | None` - Current request ID
- `set_request_id(request_id: str)` - Set request ID
- `clear_request_id()` - Clear request ID
- `get_trace_id() -> str | None` - Current trace ID
- `set_trace_id(trace_id: str)` - Set trace ID
- `increment_trace_id()` - Add .N to trace ID
- `append_trace_segment(segment: str)` - Append to trace ID
- `clear_trace_id()` - Clear trace ID

**Classes:**
- `ObservabilityMiddleware` - FastAPI/Starlette middleware
- `StructuredFormatter` - JSON log formatter
- `ContextFilter` - Adds request ID to logs
